name: Build-and-Release-Satellite-Firmware

on:
  push:
    branches:
      - main
      - develop
      - staging
      - feature/32-release-actions
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release (optional). If not provided, it will be auto-generated.'
        required: false

env:
  DEFAULT_PYTHON: "3.9"
permissions:
  contents: write
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_cfg_files: ${{ steps.dump.outputs.files }} # list of files separated by \n
      commit_id: ${{ steps.dump.outputs.commit }}
      previous_tag: ${{ steps.dump.outputs.previous_tag }}
      next_tag: ${{ steps.set_release_tag.outputs.release_tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4.1.6

      - name: Set Manual Tag (if provided)
        id: set_tag
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '' }}
        run: echo "manual_tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Bump version
        if: ${{ !steps.set_tag.outputs.manual_tag }} # if manual tag is provided, use it
        uses: anothrNick/github-tag-action@1.61.0
        id: bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # To create a major bump add #major to commit message
          DEFAULT_BUMP: ${{ github.ref_name == 'main' && 'minor' || github.ref_name == 'staging' && 'minor' || 'patch' }}
          WITH_V: true
          PRERELEASE: ${{ github.ref_name != 'main' }}
          PRERELEASE_SUFFIX: ${{ github.ref_name == 'dev' && 'alpha' || 'rc' }}
          DRY_RUN: true # Prevent action from pushing the tag.

      - name: Set tag for release
        if: ${{ steps.set_tag.outputs.manual_tag || steps.bump.outputs.tag }}
        id: set_release_tag
        run: |
            if [ -z "${{ steps.set_tag.outputs.manual_tag }}" ]; then
              echo "release_tag=${{ steps.bump.outputs.tag }}" >> $GITHUB_OUTPUT
            else
              echo "release_tag=${{ steps.set_tag.outputs.manual_tag }}" >> $GITHUB_OUTPUT
            fi

      - id: dump
        name: Set outputs
        run: |
          echo "gh_env=${{ github.ref_name == 'main' && 'production' || github.ref_name == 'staging' && 'beta' || 'alpha' }}" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "long_version=${{ steps.set_release_tag.outputs.release_tag }}_$(date +%Y-%m-%d)_$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "label_version=$(echo "${{ steps.set_release_tag.outputs.release_tag }}" | sed 's/\./dot/g' | sed 's/-/dash/g')" >> $GITHUB_OUTPUT
          echo "previous_tag=$(git describe --abbrev=0 --tags)" >> $GITHUB_OUTPUT
          echo "files=$(ls config/satellite*.yaml | jq --slurp --raw-input )" >> $GITHUB_OUTPUT

      - name: Release Changelog Builder
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          fromTag: ${{ steps.dump.outputs.previous_tag }}

      - name: debug files
        run: |
          mkdir -p files/satellite-va-rev1
          mkdir -p files/satellite-va-rev2
          touch files/satellite-va-rev1/config.yaml
          touch files/satellite-va-rev2/config.yaml
          touch files/satellite-va-rev1/misc.bin
          touch files/satellite-va-rev2/misc.bin
          touch files/satellite-va-rev1/misc1.bin
          touch files/satellite-va-rev2/misc1.bin
      - name: Upload debug files
        uses: actions/upload-artifact@v3.1.2
        with:
          path: files

  # build-firmware:
  #   name: Build Firmware
  #   needs:
  #     - prepare
  #   uses: esphome/workflows/.github/workflows/build.yml@main
  #   with:
  #     files: ${{ fromJSON(needs.prepare.outputs.build_cfg_files) }}
  #     esphome-version: 2024.6.0
  #     release-version: ${{ needs.prepare.outputs.next_tag }}


  create_artifacts:
    name: Upload Zip Artifacts
    needs:
      # - build-firmware
      - prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          path: files

      - name: Create zip files
        run: |
          mkdir -p build
          echo "Copying all files to build directory"
          find files -name "*.bin" -exec cp {} build/ \;
          zip -r build.zip build

      - run: tree
      - name: Upload artifact
        uses: actions/upload-artifact@v3.1.2
        with:
          name: zip-artifacts
          path: build.zip

  create_release:
    name: Create Release
    needs:
      - create_artifacts
      - prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3.0.2
        with:
          name: zip-artifacts
          path: files

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: files/release.zip
          generate_release_notes: true
          append_body: true
          body: ${{ needs.prepare.outputs.changelog }}
          tag_name: ${{ needs.prepare.outputs.next_tag }}
          draft: true


# Push tag to repository
