name: Build-Satellite-Firmware

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '.github/**'
      - 'config/satellite*'
  pull_request:
  workflow_dispatch:
  release:
    types: [published]

env:
  DEFAULT_PYTHON: "3.9"

jobs:
  build-list-all:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4.1.6
      - name: Find all YAML satellite files
        id: set-matrix
        run: echo "matrix=$(ls config/satellite*.yaml | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT
  
  build-list:    
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.convert_to_list.outputs.files }}
      any_changed: ${{ steps.changed-satellite-files.outputs.any_changed }}
      files: ${{ steps.changed-satellite-files.outputs.all_changed_files }}
    steps:  
      - name: Get all changed satellite files
        id: changed-satellite-files
        uses: tj-actions/changed-files@v44
        with:
          # Avoid using single or double quotes for multiline patterns
          files: |
             config/satellite*.yaml
      - name: convert to new line separated string
        id: convert_to_list
        env:
          CHANGED_FILES: ${{ toJSON(steps.changed-satellite-files.outputs.all_changed_files) }}
        run: |
          ARR=()
          for file in ${CHANGED_FILES}; do
            echo "$file was changed"
            ARR+=($file)
          done
          printf -v JOINED '%s\n' "${ARR[@]}"
          echo $ARR
          echo "$JOINED"
          echo ""
          echo "matrix=$(echo $JOINED " jq --slurp --raw-input")" >> $GITHUB_OUTPUT

  debug-list:
    runs-on: ubuntu-latest
    needs:
      - build-list
    steps:  
      - name: echo out
        id: echo_out
        env:
          CHANGED_FILES: ${{ needs.build-list.outputs.files }}
        run: |
          ARR=()
          for file in ${CHANGED_FILES}; do
            echo "$file was changed"
            ARR+=($file)
          done
          printf -v JOINED '%s\n' "${ARR[@]}"
          echo $ARR
          echo "$JOINED"
          
      
      - name: echo out matrix
        id: echo_out_matrix
        env:
          CHANGED_FILES: ${{ needs.build-list.outputs.matrix }}
        run: |
          echo $CHANGED_FILES
  
  build-firmware-changed:
    if: needs.build-list.outputs.any_changed == 'True'
    name: Build Firmware
    needs:
      - build-list

    uses: esphome/workflows/.github/workflows/build.yml@main
    with:
      files: ${{ needs.build-list.outputs.matrix }}
      esphome-version: 2024.6.0
      release-summary: ${{ github.event_name == 'release' && github.event.release.body || '' }}
      release-url: ${{ github.event_name == 'release' && github.event.release.html_url || '' }}
      release-version: ${{ github.event_name == 'release' && github.event.release.tag_name || '' }}
      