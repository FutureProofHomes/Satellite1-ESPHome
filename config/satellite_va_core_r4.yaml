substitutions:
  node_name: satellite1-voice-assistant
  core_revision: "4"

packages:
  device_base: !include common/board.yaml
  wifi: !include common/wifi_improv_r4.yaml
  local: !include common/local_components.yaml
  buttons: !include common/buttons_r4.yaml
  voice_kernel: !include common/nabu_vk_duplex_r4.yaml
  voice_assistant: !include common/va_r4.yaml
  led_ring: !include common/led_ring_r4.yaml
  hat_sensors: !include common/hat_sensors_r3.yaml
  timer: !include common/timer_r4.yaml
  # versioning: !include common/versioning.yaml
  #TODO: Currently BLE tracker will cause device to intermittently crash (especially when streaming music)
  # ble_tracker: !include common/ble_tracker_r4.yaml 


esphome:
  project:
    name: FutureProofHomes.Satellite1_rev${core_revision}
    version: dev
  
  on_boot:
    priority: 375
    then:
      # Run the script to refresh the LED status
      - script.execute: control_leds
      - delay: 1s
      
      # If after 10 minutes, the device is still initializing (It did not yet connect to Home Assistant), turn off the init_in_progress variable and run the script to refresh the LED status
      - delay: 10min
      - if:
          condition:
            lambda: return id(init_in_progress);
          then:
            - lambda: id(init_in_progress) = false;
            - script.execute: control_leds


logger:
  deassert_rts_dtr: true
  hardware_uart : USB_SERIAL_JTAG
  level: DEBUG


status_led:
  pin: GPIO45


api:
  id: api_id
  on_client_connected:
    - lambda: id(init_in_progress) = false;
    - script.execute: control_leds
  on_client_disconnected:
    - script.execute: control_leds


ota:
  - platform: satellite1
    id: ota_satellite1_xmos


http_request:


i2c:
  - id: bus_a
    sda: GPIO5
    scl: GPIO6
    frequency: 400kHz
    scan: True


spi:
  - id: spi_0
    clk_pin:  GPIO40
    mosi_pin: GPIO39
    miso_pin: GPIO41
    interface: SPI3


satellite1:
  spi_id: spi_0
  cs_pin: GPIO38
  data_rate: 4000000
  spi_mode: MODE3
  xmos_rst_pin: GPIO12
  flash_sw_pin: GPIO14

# light:
#   - platform: satellite1
#     id: !extend ${led_ring_id}
#     name: Sat1 LED Ring